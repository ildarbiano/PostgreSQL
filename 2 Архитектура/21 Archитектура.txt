=============== Архитектура =============================
Создание сервера PostgreSQL
Процесс	   | 	Роль
-----------+-------------
postgres   | 	server
-----------+-------------
Process Fork (copy/clone)
-------------------------фоновые процессы:
postgres 	bgwriter	проактивная запись "грязных страниц" из buffer cache на диск
postgres 	checkpointer	запись "грязных страниц" из buffer cache на диск при наступлении checkpoint
postgres 	autovacuum	периодический запуск autovacuum
.....		...		"грязных страниц"  — это страницы, которые были изменены и ещё не записаны на диск. Это понятие связано с работой контрольной точки (checkpoint) и процессом фоновой записи (background writer, bgwriter).
postgres 	archiver	архивация и репликация WAL
-------------------------
shared memory:
-------------
	-через него общение процессов с БД.
	-Process Memory, память для процессов.
	-это область памяти, которая используется для кэширования данных и кэширования логов транзакций. Она доступна всем процессам сервера PostgreSQL. PostgreSQL использует shared memory, чтобы позволить нескольким процессам одновременно получать доступ к данным. Система управления памятью на основе кэша хранит часто используемые данные в памяти, чтобы улучшить производительность запросов. 
----------------  виды shared memory, используемые в PostgreSQL:
Pool of shared buffers 			— основной блок общей памяти, в котором PostgreSQL буферизует страницы данных. Каждый процесс бэкенда обращается к этому блоку, чтобы читать и писать страницы данных. 
Buffer WAL (Write-Ahead Logging) 	— область общей памяти, в которой хранится копия данных лога транзакций перед записью в файл WAL. Это позволяет PostgreSQL восстанавливаться после сбоев системы без потери данных. 
Buffer commit log (CLOG) 		— область общей памяти, в которой хранятся страницы лога транзакций. 
---------------- параметры, которые контролируют работу shared memory. Например: 
shared_buffers 				— задаёт объём памяти, который PostgreSQL выделяет для буферов общей памяти. По умолчанию — обычно 128 МБ, но может быть меньше, если настройки ядра не поддерживают это. Рекомендуется устанавливать значение, которое составляет 15–25% от общего объёма оперативной памяти 
shared_memory_type 			— определяет, какую реализацию общей памяти должен использовать сервер для основной области общей памяти, где хранятся буферы PostgreSQL и другие общие данные. Возможные значения: mmap (для анонимной общей памяти, выделенной с помощью mmap), sysv (для общей памяти System V, выделенной с помощью shmget) и windows (для общей памяти Windows).



=============== Пользователи =============================
Процесс	   | 	Роль
-----------+-------------
postgres   | 	server
-----------+-------------
Process Fork (copy/clone)
-----------+-------------
shared memory:
	   ^	
-----------^-------------backend процессы:
postgres   | 	backend		|	<<<< User 1, взаимодействует через backend process
-----------+-------------
postgres   | 	backend		|	<<<< User 2, взаимодействует через backend process
-----------+-------------
-----------+-------------
postgres   | 	backend		|	<<<< User 100 max (default). максимальное количество определяется параметром max_connections.
-----------+-------------


=============== Буферный cash. Backend process =============================
-	Backend process, - обслуживающий процесс, который обрабатывает все запросы и утверждения, отправленные одним подключённым клиентом. 
-	Session Memory, память для (default 100) пользовательских сессий.
-	Взаимодействует с клиентом через одно TCP-соединение.
-	Завершается, как только клиент отсоединяется.
-	Может работать только с одной базой данных, при подключении к серверу PostgreSQL необходимо чётко указать именно ту базу данных, которая необходима.
-	Когда к серверу подключается много клиентов, для каждого из них порождается собственный обслуживающий процесс.
--------------- Параметры Backend process:
max_connections 		— определяет максимальное количество одновременных подключений к БД (по умолчанию — 100 подключений). 
work_mem 			— задаёт максимальный объём памяти, который может быть выделен обслуживающему процессу. Нулевое значение снимает ограничение. 
backend_flush_after 		— когда одним обслуживающим процессом записывается больше заданного объёма данных, сервер даёт указание ОС произвести запись этих данных в нижележащее хранилище. Это ограничивает объём «грязных» данных в страничном кеше ядра и уменьшает вероятность затормаживания при выполнении fsync в конце контрольной точки или когда ОС сбрасывает данные на диск большими порциями в фоне. 


================ Session ====================================================
выполняет запрос такой цепочки, которая требует времени и памяти:
Parser			-— это модуль, который анализирует синтаксис запроса SQL и преобразует его в дерево разбора, parse tree — иерархическую структуру данных, представляющую структуру запроса;
Analyser		-— анализатор запроса. Он проводит семантический анализ дерева разбора, которое генерируется парсером, и формирует Query tree — внутреннее представление оператора SQL, в котором все образующие его части хранятся отдельно; 
Rewriter		-— компонент, который оптимизирует запросы для улучшения их производительности. Он анализирует запрос и применяет различные техники оптимизации, чтобы переписать и перестроить план выполнения запроса; 
Planner			-— планировщик запросов, оптимизатор. Его задача — построить наилучший план выполнения SQL-запроса. Планировщик решает, как выполнить запрос: какой индекс задействовать, как соединить таблицы (Nested Loop, Hash Join, Merge Join), делать ли последовательное сканирование и т. д..
Executor		-— это модуль, который выполняет план выполнения запроса, созданный планировщиком (оптимизатором). Он отвечает за получение данных из механизма хранения, выполнение соответствующих операторов на основе дерева плана запроса и получение окончательных результатов запроса.





